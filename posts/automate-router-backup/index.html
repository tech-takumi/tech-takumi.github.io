<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>How to Automate Your Router&#39;s Backup and Keep Your Sanity Intact | Tech Takumi</title>
<meta name="keywords" content="">
<meta name="description" content="Automating My Fritz!Box Backup: The Quest for Router Zen Every techie knows that there’s nothing quite like the feeling of having your entire setup just&hellip; work. But let’s be honest—this nirvana is often more myth than reality. I’ve always envisioned automating the configuration of all my devices, making it reproducible, and yes, even bulletproof. The router, of course, had to be part of this vision.
Why Bother with Router Backups? Let’s face it—routers are the unsung heroes of our homes.">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/posts/automate-router-backup/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css" integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/automate-router-backup/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Tech Takumi (Alt + H)">Tech Takumi</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      How to Automate Your Router&#39;s Backup and Keep Your Sanity Intact
    </h1>
    <div class="post-meta"><span title='2024-08-17 23:47:55 +0200 CEST'>August 17, 2024</span>

</div>
  </header> 
  <div class="post-content"><h2 id="automating-my-fritzbox-backup-the-quest-for-router-zen">Automating My Fritz!Box Backup: The Quest for Router Zen<a hidden class="anchor" aria-hidden="true" href="#automating-my-fritzbox-backup-the-quest-for-router-zen">#</a></h2>
<p>Every techie knows that there’s nothing quite like the feeling of having your entire setup just&hellip; work. But let’s be honest—this nirvana is often more myth than reality. I’ve always envisioned automating the configuration of all my devices, making it reproducible, and yes, even bulletproof. The router, of course, had to be part of this vision.</p>
<h3 id="why-bother-with-router-backups">Why Bother with Router Backups?<a hidden class="anchor" aria-hidden="true" href="#why-bother-with-router-backups">#</a></h3>
<p>Let’s face it—routers are the unsung heroes of our homes. They work tirelessly, beaming Wi-Fi signals through walls, surviving firmware updates, and sometimes even a curious toddler’s “experiments.” Yet, when it comes to backup, they get no love. I decided it was time to change that.</p>
<p>Now, before you ask—yes, I had this romantic notion of achieving a point-in-time recovery of my <a href="https://en.avm.de/products/fritzbox/fritzbox-7530-ax/">FRITZ!Box 7530 AX</a> configurations. It’s less about fearing hardware failure (though that’s still a thing) and more about maintaining a snapshot of my configurations. After all, how interchangeable are these backups between devices? (Spoiler: I still don’t know, but Linux’s <code>file</code> command seems optimistic.)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>rodrigo@ws1:~/Downloads<span style="color:#f92672">]</span>$ file FRITZ.Box_7530_AX_256.07.80i_10.08.24_1840.export 
</span></span><span style="display:flex;"><span>FRITZ.Box_7530_AX_256.07.80i_10.08.24_1840.export: FRITZ!Box configuration backup of 7530, firmware version 256.07.80, oem avme, language en, Sat Aug <span style="color:#ae81ff">10</span> 18:40:03 <span style="color:#ae81ff">2024</span>
</span></span></code></pre></div><h3 id="the-automation-journey-a-road-paved-with-obstacles">The Automation Journey: A Road Paved with Obstacles<a hidden class="anchor" aria-hidden="true" href="#the-automation-journey-a-road-paved-with-obstacles">#</a></h3>
<p><strong>Surviving Firmware Updates:</strong></p>
<p>It’s a real conundrum. While I can manually back up my configurations, the sticky issue is secrets. Apparently, the backup includes this crucial bit, and decrypting it with my password isn’t as straightforward as it should be. But hey, there’s a tool for that! (Thanks, PeterPawn’s <a href="https://github.com/PeterPawn/decoder">decoder</a>).</p>
<p><strong>Automation Inspiration:</strong></p>
<p>Enter <a href="https://solence.de/2017/03/28/scripting-an-automated-backup-for-an-avm-fritzbox-router/">Solence&rsquo;s blog</a>. A goldmine, albeit one that doesn’t completely solve the modern-day conundrum of Multi-Factor Authentication (MFA). And no, disabling MFA isn’t an option—I’m not that reckless.</p>
<p>Instead, I had the brilliant idea of using the <a href="https://developer.1password.com/docs/cli/secrets-scripts/">1Password CLI</a> to get MFA One-Time Passwords (OTP). This way, I could automate the entire process, including those pesky OTPs. Setting up MFA for a user specifically designed for backups? Check.</p>
<p><strong>Packaging It All Up:</strong></p>
<p>The next logical step was to package this into a Docker image, because who doesn’t love a good containerized solution? I dove into <a href="https://nix.dev/tutorials/nixos/building-and-running-docker-images.html">Nix</a>, spent some quality time with <a href="https://nixos.wiki/wiki/Flakes">Flakes</a>, and battled an existential crisis when the build process complained that my new package was already defined somewhere in Nix stores. Seriously, Nix, make up your mind!</p>
<p>With some help from ChatGPT, I managed to structure the project properly, integrating <code>op</code> and <code>curl</code> into the Docker image. A few iterations later—boom! The first image was born. It wasn’t pretty, but it worked (well, sort of).</p>
<h3 id="the-final-hurdle-mfa-shenanigans-and-the-push-service-surprise">The Final Hurdle: MFA Shenanigans and the Push Service Surprise<a hidden class="anchor" aria-hidden="true" href="#the-final-hurdle-mfa-shenanigans-and-the-push-service-surprise">#</a></h3>
<p><strong>MFA Madness:</strong></p>
<p>No automation project is complete without a final, face-palm-worthy challenge. For me, it was the realization that my FRITZ!Box has a push service that can send backups of the configuration. That’s right—I was a hairsbreadth away from victory when I discovered I could have simply received the backup via email. But where’s the fun in that? Besides it only sends information when firmware is about to be updated or someone triggers a factory reset. I want more peace of mind than that!</p>
<p>So, I moved into capturing all the traffic between my browser and the router (good old <code>dev tool</code> in Chrome), parsing through the noise until I found the relevant calls to <code>data.lua</code> and <code>two_factor.lua</code>. And just like that, I could finally automate the backup download without needing to physically click the router’s buttons. Victory never tasted so sweet.</p>
<p><strong>Publishing the Docker Image:</strong></p>
<p>Of course, I had to publish my creation. Initially, I planned to put everything on GitHub and host the image on Docker Hub. But after squashing some embarrassing history from my repo (I may or may not have pushed a token to Gitea), I decided to skip GitHub and push directly to Docker Hub.</p>
<p>Here’s where you can find it: <a href="https://hub.docker.com/repository/docker/rcouto/fritzbox-backup-docker">rcouto/fritzbox-backup-docker</a>. Enjoy!</p>
<h3 id="scheduling-and-storing-backups">Scheduling and Storing Backups<a hidden class="anchor" aria-hidden="true" href="#scheduling-and-storing-backups">#</a></h3>
<p>The final piece of the puzzle was figuring out where to store the backups and how to schedule the runs. The answer? My trusty <a href="https://www.lincplustech.com/products/lincstation-n1-network-attached-storage">Lincstation N1 NAS</a>, where backups could live in peace, gzip-compressed and taking up a mere 30KB a day.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>BACKUP_DIR<span style="color:#f92672">=</span>/mnt/user/backup/fritzbox
</span></span><span style="display:flex;"><span>TOKEN<span style="color:#f92672">=</span>/root/.1p_token
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docker run --rm -v <span style="color:#e6db74">${</span>TOKEN<span style="color:#e6db74">}</span>:/etc/token:ro -v <span style="color:#e6db74">${</span>BACKUP_DIR<span style="color:#e6db74">}</span>:/mnt/backup:rw rcouto/fritzbox-backup-docker
</span></span><span style="display:flex;"><span>gzip -9 <span style="color:#e6db74">${</span>BACKUP_DIR<span style="color:#e6db74">}</span>/*.export
</span></span></code></pre></div><p>Scheduled via the “User Scripts” plugin on Unraid, this script now runs daily, backing up my Fritz!Box configurations like clockwork.</p>
<h3 id="the-final-frontier-vulnerabilities-and-backup-rotation">The Final Frontier: Vulnerabilities and Backup Rotation<a hidden class="anchor" aria-hidden="true" href="#the-final-frontier-vulnerabilities-and-backup-rotation">#</a></h3>
<p>No good deed goes unpunished. My image was flagged for vulnerabilities in Docker Hubs, but that’s a battle for another day. For now, I’m content with the knowledge that my backups are automated, my configurations are safe, and my router will live to see another firmware update—without breaking a sweat.</p>
<p>In conclusion, the journey to automate my Fritz!Box backups was riddled with challenges, from MFA to Docker quirks, but in the end, it was all worth it. Who knows? Maybe one day, I’ll automate my entire life. But for now, I’ll settle for router zen.</p>
<hr>
<p><strong>References:</strong></p>
<ul>
<li><a href="https://solence.de/2017/03/28/scripting-an-automated-backup-for-an-avm-fritzbox-router/">Scripting an Automated Backup for an AVM FRITZ!Box Router</a></li>
<li><a href="https://developer.1password.com/docs/cli/secrets-scripts/">1Password CLI Documentation</a></li>
<li><a href="https://nix.dev/tutorials/nixos/building-and-running-docker-images.html">Nix Docker Tutorial</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="http://localhost:1313/">Tech Takumi</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
